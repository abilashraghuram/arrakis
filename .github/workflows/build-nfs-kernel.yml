name: Build NFS-Enabled Kernel

on:
  push:
    branches: ["main", "kernel-build"]
    paths:
      - ".github/workflows/build-nfs-kernel.yml"
  pull_request:
    branches: ["main"]
  workflow_dispatch:
    inputs:
      kernel_branch:
        description: "Kernel branch to build"
        required: false
        default: "microvm-kernel-6.1.102-1.182.amzn2023"

permissions:
  contents: write
  packages: write

jobs:
  build-kernel:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install kernel build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libncurses-dev \
            bison \
            flex \
            libssl-dev \
            libelf-dev \
            bc \
            kmod \
            cpio \
            wget \
            rsync

      - name: Clone Amazon Linux kernel
        run: |
          KERNEL_BRANCH="${{ github.event.inputs.kernel_branch || 'microvm-kernel-6.1.102-1.182.amzn2023' }}"
          echo "Building kernel from branch: $KERNEL_BRANCH"
          git clone --depth 1 --branch "$KERNEL_BRANCH" \
            https://github.com/amazonlinux/linux.git linux-amazon
          cd linux-amazon
          echo "Kernel source cloned successfully"
          git log -1 --oneline

      - name: Download Firecracker kernel configuration
        run: |
          cd linux-amazon
          curl -L -o .config \
            "https://raw.githubusercontent.com/firecracker-microvm/firecracker/refs/heads/firecracker-v1.10/resources/guest_configs/microvm-kernel-ci-x86_64-6.1.config"
          echo "Downloaded Firecracker kernel config"
          ls -lh .config

      - name: Configure kernel for NFS support
        run: |
          cd linux-amazon

          # Disable certificate/keyring requirements
          ./scripts/config --disable SYSTEM_TRUSTED_KEYRING
          ./scripts/config --disable SECONDARY_TRUSTED_KEYRING
          ./scripts/config --disable SYSTEM_REVOCATION_KEYS
          ./scripts/config --disable MODULE_SIG
          ./scripts/config --disable INTEGRITY
          ./scripts/config --disable IMA
          ./scripts/config --disable EVM
          ./scripts/config --set-str SYSTEM_TRUSTED_KEYS ""
          ./scripts/config --set-str SYSTEM_REVOCATION_KEYS ""

          # Enable virtio support
          ./scripts/config --enable VIRTIO_MMIO_CMDLINE_DEVICES
          ./scripts/config --disable BLK_DEV_INTEGRITY

          # Enable NFS client support
          ./scripts/config --enable NFS_FS
          ./scripts/config --enable NFS_V2
          ./scripts/config --enable NFS_V3
          ./scripts/config --enable NFS_V3_ACL
          ./scripts/config --enable NFS_V4
          ./scripts/config --enable NFS_V4_1
          ./scripts/config --enable NFS_V4_2

          # Enable RPC and locking support required for NFS
          ./scripts/config --enable SUNRPC
          ./scripts/config --enable LOCKD
          ./scripts/config --enable LOCKD_V4
          ./scripts/config --enable NFS_COMMON
          ./scripts/config --enable NETWORK_FILESYSTEMS

          # Update configuration with olddefconfig
          make olddefconfig

          echo "Kernel configuration completed"

      - name: Verify NFS configuration
        run: |
          cd linux-amazon
          echo "============================================================"
          echo "           NFS KERNEL CONFIGURATION VERIFICATION           "
          echo "============================================================"
          echo ""
          echo "NFS Configuration:"
          grep "CONFIG_NFS" .config || echo "Warning: No NFS config found"
          echo ""
          echo "SUNRPC Configuration:"
          grep "CONFIG_SUNRPC" .config || echo "Warning: No SUNRPC config found"
          echo ""
          echo "LOCKD Configuration:"
          grep "CONFIG_LOCKD" .config || echo "Warning: No LOCKD config found"
          echo "============================================================"

      - name: Build kernel
        run: |
          cd linux-amazon
          echo "Starting kernel build with $(nproc) CPU cores..."
          echo "Build started at: $(date)"

          # Build vmlinux with all available cores
          make -j$(nproc) vmlinux CC="gcc -std=gnu11"

          echo "Build completed at: $(date)"
          echo ""
          echo "Kernel binary details:"
          ls -lh vmlinux
          file vmlinux

      - name: Verify kernel has NFS support
        run: |
          cd linux-amazon
          echo "============================================================"
          echo "        VERIFYING NFS SUPPORT IN BUILT KERNEL             "
          echo "============================================================"
          echo ""
          echo "Checking for NFS symbols in kernel binary:"
          strings vmlinux | grep -i "nfs_fs" | head -5 || echo "Warning: nfs_fs not found"
          strings vmlinux | grep -i "sunrpc" | head -5 || echo "Warning: sunrpc not found"
          strings vmlinux | grep -i "lockd" | head -5 || echo "Warning: lockd not found"
          echo ""
          echo "Kernel version:"
          strings vmlinux | grep "Linux version" | head -1
          echo "============================================================"

      - name: Create release artifacts directory
        run: mkdir -p release-artifacts

      - name: Copy kernel to artifacts
        run: |
          cp linux-amazon/vmlinux release-artifacts/vmlinux-nfs.bin
          cp linux-amazon/.config release-artifacts/kernel-config-nfs

          echo "Kernel binary copied to release artifacts"
          ls -lh release-artifacts/

      - name: Create kernel VERSION file
        run: |
          cd linux-amazon
          KERNEL_VERSION=$(make kernelversion)
          COMMIT_HASH=$(git rev-parse --short HEAD)

          cat > ../release-artifacts/KERNEL-VERSION << EOF
          KERNEL_VERSION=$KERNEL_VERSION
          KERNEL_SOURCE=amazonlinux/linux
          KERNEL_BRANCH=${{ github.event.inputs.kernel_branch || 'microvm-kernel-6.1.102-1.182.amzn2023' }}
          KERNEL_COMMIT=$COMMIT_HASH
          BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          BUILD_BY=GitHub Actions
          BUILD_ID=${{ github.run_id }}
          BUILD_NUMBER=${{ github.run_number }}
          ARRAKIS_COMMIT=${{ github.sha }}
          ARRAKIS_COMMIT_SHORT=$(echo ${{ github.sha }} | cut -c1-8)
          NFS_SUPPORT=enabled
          FEATURES=nfs,nfsv3,nfsv4,sunrpc,lockd,virtio
          CONFIG=firecracker-microvm-base
          EOF

          echo ""
          echo "KERNEL-VERSION file contents:"
          cat ../release-artifacts/KERNEL-VERSION

      - name: Create kernel info summary
        run: |
          cd release-artifacts
          cat > KERNEL-INFO.md << 'EOF'
          # NFS-Enabled Kernel for Arrakis

          ## Overview
          This kernel is built from Amazon Linux kernel sources with Firecracker microVM configuration, enhanced with NFS client support.

          ## Features
          - **Base**: Amazon Linux Kernel (Firecracker optimized)
          - **NFS Support**: NFSv2, NFSv3, NFSv4, NFSv4.1, NFSv4.2
          - **Network Filesystem**: Full SUNRPC and LOCKD support
          - **Optimized**: Minimal configuration for microVMs
          - **Virtio**: Full virtio device support

          ## Usage with Arrakis

          ### Installation
          ```bash
          # Download the kernel
          wget https://github.com/YOUR_ORG/arrakis/releases/download/RELEASE_TAG/vmlinux-nfs.bin

          # Copy to Arrakis runtime directory
          cp vmlinux-nfs.bin ~/arrakis-runtime/resources/bin/vmlinux.bin
          ```

          ### Verify NFS Support
          ```bash
          # Check kernel has NFS compiled in
          strings vmlinux-nfs.bin | grep "nfs_fs"
          ```

          ## Build Information
          See `KERNEL-VERSION` file for detailed build information.

          ## Configuration
          The kernel configuration file is available as `kernel-config-nfs` in this release.

          ## Testing
          Once installed, VMs created with Arrakis will be able to:
          - Boot with NFS root filesystem
          - Mount NFS exports from AgentFS
          - Use network-based root filesystem for tracking

          ## Compatibility
          - **Cloud Hypervisor**: Compatible
          - **Firecracker**: Compatible
          - **QEMU**: Compatible (virtio devices)
          EOF

          echo "Kernel info documentation created"

      - name: Calculate checksums
        run: |
          cd release-artifacts
          sha256sum vmlinux-nfs.bin > vmlinux-nfs.bin.sha256
          sha256sum kernel-config-nfs > kernel-config-nfs.sha256

          echo "Checksums calculated:"
          cat vmlinux-nfs.bin.sha256
          cat kernel-config-nfs.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nfs-kernel-artifacts
          path: release-artifacts/
          retention-days: 30

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          name: NFS Kernel Build ${{ github.run_number }}
          tag_name: kernel-nfs-${{ github.run_number }}
          body_path: release-artifacts/KERNEL-INFO.md
          files: |
            release-artifacts/vmlinux-nfs.bin
            release-artifacts/vmlinux-nfs.bin.sha256
            release-artifacts/kernel-config-nfs
            release-artifacts/kernel-config-nfs.sha256
            release-artifacts/KERNEL-VERSION
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        if: always()
        run: |
          echo "## Kernel Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f release-artifacts/vmlinux-nfs.bin ]; then
            echo "✅ Kernel built successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- Kernel binary: \`vmlinux-nfs.bin\` ($(du -h release-artifacts/vmlinux-nfs.bin | cut -f1))" >> $GITHUB_STEP_SUMMARY
            echo "- Configuration: \`kernel-config-nfs\`" >> $GITHUB_STEP_SUMMARY
            echo "- Version info: \`KERNEL-VERSION\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Checksums" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat release-artifacts/vmlinux-nfs.bin.sha256 >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Kernel build failed!" >> $GITHUB_STEP_SUMMARY
          fi
